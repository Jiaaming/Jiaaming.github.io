<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Microsoft Intern Summary: Merging Servers in the VSCode Gradle Extension | Jiaming's Blog</title><meta name=keywords content="技术"><meta name=description content="Project Background Communication Between Servers Architecture Before the Merge Why Merge? How to Merge Architecture After the Merge Step 1: Merging Task Server and Build Server Challenges Connection Workflow Step 2: Merging Language Server to Gradle Server Performance After Merge How Was Performance Measured? Pre-Merge Memory Monitoring Post-Merge Memory Monitoring Performance Results Small Medium Large Super Large Project Background During my internship at Microsoft, I worked on the VSCode Gradle Extension."><meta name=author content="Me"><link rel=canonical href=https://jiaaming.cn/en/post/ms-intern-summary/><link crossorigin=anonymous href=/assets/css/stylesheet.5cfc680b1eeaeef9efbced92d46c2a9e876b72ee14fba85846afc4cff9e6e6f8.css integrity="sha256-XPxoCx7q7vnvvO2S1Gwqnodrcu4U+6hYRq/Ez/nm5vg=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG+9vmJ0cTS+ovo0FeA=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://jiaaming.cn/%3Clink%20/%20abs%20url%3E><link rel=icon type=image/png sizes=16x16 href=https://jiaaming.cn/%3Clink%20/%20abs%20url%3E><link rel=icon type=image/png sizes=32x32 href=https://jiaaming.cn/%3Clink%20/%20abs%20url%3E><link rel=apple-touch-icon href=https://jiaaming.cn/%3Clink%20/%20abs%20url%3E><link rel=mask-icon href=https://jiaaming.cn/%3Clink%20/%20abs%20url%3E><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><script type=application/javascript>var doNotTrack=!1;doNotTrack||(function(e,t,n,s,o,i,a){e.GoogleAnalyticsObject=o,e[o]=e[o]||function(){(e[o].q=e[o].q||[]).push(arguments)},e[o].l=1*new Date,i=t.createElement(n),a=t.getElementsByTagName(n)[0],i.async=1,i.src=s,a.parentNode.insertBefore(i,a)}(window,document,"script","https://www.google-analytics.com/analytics.js","ga"),ga("create","UA-123-45","auto"),ga("send","pageview"))</script><meta property="og:title" content="Microsoft Intern Summary: Merging Servers in the VSCode Gradle Extension"><meta property="og:description" content="Project Background Communication Between Servers Architecture Before the Merge Why Merge? How to Merge Architecture After the Merge Step 1: Merging Task Server and Build Server Challenges Connection Workflow Step 2: Merging Language Server to Gradle Server Performance After Merge How Was Performance Measured? Pre-Merge Memory Monitoring Post-Merge Memory Monitoring Performance Results Small Medium Large Super Large Project Background During my internship at Microsoft, I worked on the VSCode Gradle Extension."><meta property="og:type" content="article"><meta property="og:url" content="https://jiaaming.cn/en/post/ms-intern-summary/"><meta property="og:image" content="https://jiaaming.cn/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta property="article:section" content="en"><meta property="article:published_time" content="2024-08-03T00:00:00+00:00"><meta property="article:modified_time" content="2024-08-03T00:00:00+00:00"><meta property="og:site_name" content="Jiaming's Blog"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://jiaaming.cn/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta name=twitter:title content="Microsoft Intern Summary: Merging Servers in the VSCode Gradle Extension"><meta name=twitter:description content="Project Background Communication Between Servers Architecture Before the Merge Why Merge? How to Merge Architecture After the Merge Step 1: Merging Task Server and Build Server Challenges Connection Workflow Step 2: Merging Language Server to Gradle Server Performance After Merge How Was Performance Measured? Pre-Merge Memory Monitoring Post-Merge Memory Monitoring Performance Results Small Medium Large Super Large Project Background During my internship at Microsoft, I worked on the VSCode Gradle Extension."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":2,"name":"Microsoft Intern Summary: Merging Servers in the VSCode Gradle Extension","item":"https://jiaaming.cn/en/post/ms-intern-summary/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Microsoft Intern Summary: Merging Servers in the VSCode Gradle Extension","name":"Microsoft Intern Summary: Merging Servers in the VSCode Gradle Extension","description":"Project Background Communication Between Servers Architecture Before the Merge Why Merge? How to Merge Architecture After the Merge Step 1: Merging Task Server and Build Server Challenges Connection Workflow Step 2: Merging Language Server to Gradle Server Performance After Merge How Was Performance Measured? Pre-Merge Memory Monitoring Post-Merge Memory Monitoring Performance Results Small Medium Large Super Large Project Background During my internship at Microsoft, I worked on the VSCode Gradle Extension.","keywords":["技术"],"articleBody":" Project Background Communication Between Servers Architecture Before the Merge Why Merge? How to Merge Architecture After the Merge Step 1: Merging Task Server and Build Server Challenges Connection Workflow Step 2: Merging Language Server to Gradle Server Performance After Merge How Was Performance Measured? Pre-Merge Memory Monitoring Post-Merge Memory Monitoring Performance Results Small Medium Large Super Large Project Background During my internship at Microsoft, I worked on the VSCode Gradle Extension. This extension was initially divided into three components:\nGradle Task Server: Runs in the background, providing project and task information, and executing Gradle tasks. Gradle Language Server: Offers language features such as code completion and diagnostics for Gradle script files. Gradle Project Importer: Imports Gradle projects detected by the Gradle Build Server into the workspace. My role was to merge these servers into a single process, with each component running in a separate thread, thereby reducing memory usage. This consolidation is crucial for integrating the extension into the VSCode Java Pack, which is widely used by VSCode Java developers.\nCommunication Between Servers Server Client Communication Method Task Server: Java Task Client: TypeScript gRPC: TCP socket Language Server: Java Language Client: TypeScript Language Server Protocol, JSON-RPC: Stdio Build Server: Java Build Client: Java Build Server Protocol: Stdio Architecture Before the Merge Why Merge? Originally, the extension started three separate Java processes:\nTask Server: Previously called the Gradle Server, this component was adopted by Microsoft from Richard Willis and was the initial server. Language Server: Also developed by Richard Willis, providing language features. Build Server: Added by Microsoft to support project importing. More details can be found here. This setup incurred significant overhead due to running three separate processes, as shown below:\nSince our goal is to include this extension in the VSCode Java Pack, which is used by many Java developers, reducing memory consumption was essential.\nInitially, the Task Server and Language Server would start when the extension was loaded, whereas the Build Server, being an external dependency, would start on-demand when the importer was loaded.\nHow to Merge Since the three servers are independent and do not share data, modifying the startup logic to launch them simultaneously using Java multithreading was a suitable solution.\nArchitecture After the Merge Step 1: Merging Task Server and Build Server Challenges Standard I/O Issues: After merging, using standard input/output was no longer feasible due to conflicts between multiple threads. TCP sockets couldn’t be used due to security concerns, so Named Pipes were employed as a compliant solution.\nWindows Compatibility: Java’s support for named pipes on Windows is not very user-friendly, requiring complex OS-level handling. While Unix systems use Unix Domain Sockets, Windows uses AsynchronousFileChannel.\n// Connection between Build Server and Build Client org.eclipse.lsp4j.jsonrpc.Launcher\u003cBuildClient\u003e launcher = new org.eclipse.lsp4j.jsonrpc.Launcher.Builder\u003cBuildClient\u003e() .setOutput(outputStream) .setInput(inputStream) .setLocalService(gradleBuildServer) .setRemoteInterface(BuildClient.class) .setExecutorService(Executors.newCachedThreadPool()) .create(); buildTargetService.setClient(launcher.getRemoteProxy()); Named Pipe Creation: The solution required creating and listening to named pipes. In the Node.js environment, libraries like net.Socket handle this directly, enabling listening on named pipes. To bridge the gap, I implemented an additional BspProxy layer. This proxy establishes named pipe connections between the Build Server and Build Client during startup, facilitating indirect communication.\nNamed Pipe Path Generation:\nBuild Server and BspProxy: Since the Build Server can start with the extension, the extension generates a random file name upon startup, passing it to the Build Server, which then listens on that named pipe.\nBuild Client and BspProxy: The Build Client’s startup is tied to the Gradle project import process, controlled by the Java Language Server. The challenge was how the Build Client could generate and pass the named pipe path to the VSCode Extension’s BspProxy.\nLuckily, the JavaLanguageServerPlugin is able to send a notification to VSCode, informing it of the named pipe path, and the extension can then pass this information to the BspProxy.\n// Send message to VSCode private void sendImporterPipeName(String pipeName) { JavaLanguageServerPlugin.getInstance().getClientConnection() .sendNotification(\"gradle.onWillImporterConnect\", pipeName); } // Receive message from Java private registerCommand(): void { this.context.subscriptions.push( vscode.commands.registerCommand(\"gradle.onWillImporterConnect\", (pipeName: string) =\u003e { this._onImporterReady.fire(path.resolve(pipeName)); }) ); } Since the import process controls initialization, communication is one-way, using notifications. The Java side cannot receive feedback from VSCode. Therefore, polling was used to establish the connection once VSCode was ready.\nConnection Workflow The entire connection process is illustrated below:\nThis was the most complex part of the project, but it successfully merged the Build Server and Task Server.\nStep 2: Merging Language Server to Gradle Server This step was more straightforward. The VSCode Language Server and Client libraries support various connection methods.\nBy packaging the Language Server as a local dependency and using named pipes for communication, I was able to merge it with the Gradle Server seamlessly.\nDependency Management:\nThe primary challenge was handling shared dependencies between the Gradle Server and Gradle Language Server. By creating a fat JAR for the Language Server and placing it at the end of the Gradle Server’s classpath, dependency conflicts were resolved.\nCertainly! Here’s your translated and reorganized section in English:\nPerformance After Merge After Merge, it only got one single Java process GradleServer. How Was Performance Measured? Memory consumption was the primary focus after the merge. Before the merge, we could determine total memory usage by monitoring the memory consumption of each of the three separate processes. I developed a Python script to automate this process.\nPre-Merge Memory Monitoring Polling for Process IDs: The script first polls the system to find the process IDs (PIDs) of the three servers based on their class names.\nMonitoring Memory Usage: Using the psutil library, the script captures the Resident Set Size (RSS) usage of each process individually and then sums them up to obtain the total memory usage.\nThis script runs before starting VSCode to monitor memory consumption when opening a Gradle project. It outputs memory usage data every second.\nWhat is RSS Monitoring? :\nResident Set Size (RSS), a measure provided by the operating system that indicates the actual amount of physical memory occupied by a process.\nFor Java programs, RSS includes not only the Java heap memory but also Metaspace, code cache, memory used by the JVM itself, and JVM stack space.\nPost-Merge Memory Monitoring After merging the processes into a single thread, I used Plotly to visualize the memory usage:\nPlotting Memory Usage: I plotted the sum of memory usage for the three pre-merge servers against the single merged process over time. This line chart illustrates real-time memory changes as a Gradle project is opened.\nVersion Comparison: Between versions 3.13.5 (before the merge) and 3.16.2 (after the merge).\nPerformance Results To Test the performance, I used the four different size of project:\nProject Size Description Number of Gradle Tasks Small Basic project initialized with Gradle init command 34 Medium microsoft/vscode-gradle project ~380 Large apache/lucene project ~3,300 Super Large gradle/gradle project ~42,000 Small Medium Large Super Large The results showed significant memory savings, especially with smaller projects, demonstrating the efficiency of the merged architecture.\n","wordCount":"1141","inLanguage":"en","datePublished":"2024-08-03T00:00:00Z","dateModified":"2024-08-03T00:00:00Z","author":{"@type":"Person","name":"Me"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://jiaaming.cn/en/post/ms-intern-summary/"},"publisher":{"@type":"Organization","name":"Jiaming's Blog","logo":{"@type":"ImageObject","url":"https://jiaaming.cn/%3Clink%20/%20abs%20url%3E"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://jiaaming.cn/ accesskey=h title="Home (Alt + H)"><img src=https://jiaaming.cn/apple-touch-icon.png alt aria-label=logo height=35>Home</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://jiaaming.cn/en/about/ title="  About me"><span>About me</span></a></li><li><a href=https://www.pixiv.net/users/32348753 title=Art><span>Art</span>&nbsp;<svg fill="none" shape-rendering="geometricPrecision" stroke="currentcolor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" viewBox="0 0 24 24" height="12" width="12"><path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"/><path d="M15 3h6v6"/><path d="M10 14 21 3"/></svg></a></li><li><a href=https://jiaaming.cn/cv.pdf title=CV><span>CV</span></a></li><li><a href=https://running.jiaaming.cn/ title="Running Page🏃"><span>Running Page🏃</span>&nbsp;<svg fill="none" shape-rendering="geometricPrecision" stroke="currentcolor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" viewBox="0 0 24 24" height="12" width="12"><path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"/><path d="M15 3h6v6"/><path d="M10 14 21 3"/></svg></a></li><li><a href=https://jiaaming.cn/en/contact/ title=Contact><span>Contact</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://jiaaming.cn/>Home</a></div><h1 class=post-title>Microsoft Intern Summary: Merging Servers in the VSCode Gradle Extension</h1><div class=post-meta><span title='2024-08-03 00:00:00 +0000 UTC'>August 3, 2024</span>&nbsp;·&nbsp;6 min&nbsp;·&nbsp;1141 words&nbsp;·&nbsp;Me</div></header><div class=post-content><ul><li><a href=#project-background>Project Background</a><ul><li><a href=#communication-between-servers>Communication Between Servers</a></li><li><a href=#architecture-before-the-merge>Architecture Before the Merge</a></li></ul></li><li><a href=#why-merge>Why Merge?</a></li><li><a href=#how-to-merge>How to Merge</a><ul><li><a href=#architecture-after-the-merge>Architecture After the Merge</a></li><li><a href=#step-1-merging-task-server-and-build-server>Step 1: Merging Task Server and Build Server</a><ul><li><a href=#challenges>Challenges</a></li><li><a href=#connection-workflow>Connection Workflow</a></li></ul></li><li><a href=#step-2-merging-language-server-to-gradle-server>Step 2: Merging Language Server to Gradle Server</a></li></ul></li><li><a href=#performance-after-merge>Performance After Merge</a><ul><li><a href=#how-was-performance-measured>How Was Performance Measured?</a><ul><li><a href=#pre-merge-memory-monitoring>Pre-Merge Memory Monitoring</a></li><li><a href=#post-merge-memory-monitoring>Post-Merge Memory Monitoring</a></li></ul></li><li><a href=#performance-results>Performance Results</a><ul><li><a href=#small>Small</a></li><li><a href=#medium>Medium</a></li><li><a href=#large>Large</a></li><li><a href=#super-large>Super Large</a></li></ul></li></ul></li></ul><h2 id=project-background>Project Background<a hidden class=anchor aria-hidden=true href=#project-background>#</a></h2><p><img loading=lazy src=https://raw.githubusercontent.com/Jiaaming/blogImage/main/pic/20240803213701.png alt="Project Image"></p><p>During my internship at Microsoft, I worked on the <a href=https://github.com/microsoft/vscode-gradle>VSCode Gradle Extension</a>. This extension was initially divided into three components:</p><ol><li><strong>Gradle Task Server:</strong> Runs in the background, providing project and task information, and executing Gradle tasks.</li><li><strong>Gradle Language Server:</strong> Offers language features such as code completion and diagnostics for Gradle script files.</li><li><strong>Gradle Project Importer:</strong> Imports Gradle projects detected by the <strong>Gradle Build Server</strong> into the workspace.</li></ol><p>My role was to merge these servers into a single process, with each component running in a separate thread, thereby reducing memory usage. This consolidation is crucial for integrating the extension into the <a href=https://github.com/microsoft/vscode-java-pack>VSCode Java Pack</a>, which is widely used by VSCode Java developers.</p><h3 id=communication-between-servers>Communication Between Servers<a hidden class=anchor aria-hidden=true href=#communication-between-servers>#</a></h3><table><thead><tr><th>Server</th><th>Client</th><th>Communication Method</th></tr></thead><tbody><tr><td>Task Server: Java</td><td>Task Client: TypeScript</td><td><a href=https://grpc.io/>gRPC</a>: TCP socket</td></tr><tr><td>Language Server: Java</td><td>Language Client: TypeScript</td><td><a href=https://microsoft.github.io/language-server-protocol/>Language Server Protocol</a>, <a href=https://www.jsonrpc.org/specification>JSON-RPC</a>: Stdio</td></tr><tr><td>Build Server: Java</td><td>Build Client: Java</td><td><a href=https://build-server-protocol.github.io/>Build Server Protocol</a>: Stdio</td></tr></tbody></table><h3 id=architecture-before-the-merge>Architecture Before the Merge<a hidden class=anchor aria-hidden=true href=#architecture-before-the-merge>#</a></h3><p><img loading=lazy src=https://raw.githubusercontent.com/Jiaaming/blogImage/main/pic/20240803233221.png alt="Architecture Before Merge"></p><h2 id=why-merge>Why Merge?<a hidden class=anchor aria-hidden=true href=#why-merge>#</a></h2><p>Originally, the extension started three separate Java processes:</p><ol><li><strong>Task Server:</strong> Previously called the Gradle Server, this component was adopted by Microsoft from <a href=https://github.com/badsyntax>Richard Willis</a> and was the initial server.</li><li><strong>Language Server:</strong> Also developed by Richard Willis, providing language features.</li><li><strong>Build Server:</strong> Added by Microsoft to support project importing. More details can be found <a href=https://github.com/microsoft/build-server-for-gradle>here</a>.</li></ol><p>This setup incurred significant overhead due to running three separate processes, as shown below:</p><p><img loading=lazy src=https://raw.githubusercontent.com/Jiaaming/blogImage/main/pic/bfm.png alt="Process Overhead"></p><p>Since our goal is to include this extension in the VSCode Java Pack, which is used by many Java developers, reducing memory consumption was essential.</p><p>Initially, the Task Server and Language Server would start when the extension was loaded, whereas the Build Server, being an external dependency, would start on-demand when the importer was loaded.</p><h2 id=how-to-merge>How to Merge<a hidden class=anchor aria-hidden=true href=#how-to-merge>#</a></h2><p>Since the three servers are independent and do not share data, modifying the startup logic to launch them simultaneously using Java multithreading was a suitable solution.</p><h3 id=architecture-after-the-merge>Architecture After the Merge<a hidden class=anchor aria-hidden=true href=#architecture-after-the-merge>#</a></h3><p><img loading=lazy src=https://raw.githubusercontent.com/Jiaaming/blogImage/main/pic/20240804104905.png alt="Architecture After Merge"></p><h3 id=step-1-merging-task-server-and-build-server>Step 1: Merging Task Server and Build Server<a hidden class=anchor aria-hidden=true href=#step-1-merging-task-server-and-build-server>#</a></h3><h4 id=challenges>Challenges<a hidden class=anchor aria-hidden=true href=#challenges>#</a></h4><ol><li><p><strong>Standard I/O Issues:</strong> After merging, using standard input/output was no longer feasible due to conflicts between multiple threads. TCP sockets couldn&rsquo;t be used due to security concerns, so <a href=https://en.wikipedia.org/wiki/Named_pipe>Named Pipes</a> were employed as a compliant solution.</p></li><li><p><strong>Windows Compatibility:</strong> Java&rsquo;s support for named pipes on Windows is not very user-friendly, requiring complex OS-level handling. While Unix systems use Unix Domain Sockets, Windows uses AsynchronousFileChannel.</p></li></ol><div class=highlight><pre tabindex=0 class=chroma><code class=language-Java data-lang=Java><span class=line><span class=cl><span class=c1>// Connection between Build Server and Build Client
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>org</span><span class=o>.</span><span class=na>eclipse</span><span class=o>.</span><span class=na>lsp4j</span><span class=o>.</span><span class=na>jsonrpc</span><span class=o>.</span><span class=na>Launcher</span><span class=o>&lt;</span><span class=n>BuildClient</span><span class=o>&gt;</span> <span class=n>launcher</span> <span class=o>=</span> <span class=k>new</span> 
</span></span><span class=line><span class=cl>    <span class=n>org</span><span class=o>.</span><span class=na>eclipse</span><span class=o>.</span><span class=na>lsp4j</span><span class=o>.</span><span class=na>jsonrpc</span><span class=o>.</span><span class=na>Launcher</span><span class=o>.</span><span class=na>Builder</span><span class=o>&lt;</span><span class=n>BuildClient</span><span class=o>&gt;()</span>
</span></span><span class=line><span class=cl>    <span class=o>.</span><span class=na>setOutput</span><span class=o>(</span><span class=n>outputStream</span><span class=o>)</span>
</span></span><span class=line><span class=cl>    <span class=o>.</span><span class=na>setInput</span><span class=o>(</span><span class=n>inputStream</span><span class=o>)</span>
</span></span><span class=line><span class=cl>    <span class=o>.</span><span class=na>setLocalService</span><span class=o>(</span><span class=n>gradleBuildServer</span><span class=o>)</span>
</span></span><span class=line><span class=cl>    <span class=o>.</span><span class=na>setRemoteInterface</span><span class=o>(</span><span class=n>BuildClient</span><span class=o>.</span><span class=na>class</span><span class=o>)</span>
</span></span><span class=line><span class=cl>    <span class=o>.</span><span class=na>setExecutorService</span><span class=o>(</span><span class=n>Executors</span><span class=o>.</span><span class=na>newCachedThreadPool</span><span class=o>())</span>
</span></span><span class=line><span class=cl>    <span class=o>.</span><span class=na>create</span><span class=o>();</span>
</span></span><span class=line><span class=cl><span class=n>buildTargetService</span><span class=o>.</span><span class=na>setClient</span><span class=o>(</span><span class=n>launcher</span><span class=o>.</span><span class=na>getRemoteProxy</span><span class=o>());</span>
</span></span></code></pre></div><ol start=3><li><strong>Named Pipe Creation:</strong> The solution required creating and listening to named pipes. In the Node.js environment, libraries like <a href=https://nodejs.org/api/net.html#netcreateserveroptions-connectionlistener>net.Socket</a> handle this directly, enabling listening on named pipes.</li></ol><p>To bridge the gap, I implemented an additional <a href=https://github.com/microsoft/vscode-gradle/blob/b71fcb2e1e4c8aeafc9ece92a13659f47e5c6009/extension/src/bs/BspProxy.ts#L16>BspProxy</a> layer. This proxy establishes named pipe connections between the Build Server and Build Client during startup, facilitating indirect communication.</p><ol start=4><li><p><strong>Named Pipe Path Generation:</strong></p><ul><li><p><strong>Build Server and BspProxy:</strong> Since the Build Server can start with the extension, the extension generates a random file name upon startup, passing it to the Build Server, which then listens on that named pipe.</p></li><li><p><strong>Build Client and BspProxy:</strong> The Build Client&rsquo;s startup is tied to the Gradle project import process, controlled by the Java Language Server. The challenge was how the Build Client could generate and pass the named pipe path to the VSCode Extension&rsquo;s BspProxy.</p></li></ul></li></ol><p>Luckily, the <code>JavaLanguageServerPlugin</code> is able to send a notification to VSCode, informing it of the named pipe path, and the extension can then pass this information to the BspProxy.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// Send message to VSCode
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>private</span> <span class=kt>void</span> <span class=nf>sendImporterPipeName</span><span class=o>(</span><span class=n>String</span> <span class=n>pipeName</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>JavaLanguageServerPlugin</span><span class=o>.</span><span class=na>getInstance</span><span class=o>().</span><span class=na>getClientConnection</span><span class=o>()</span>
</span></span><span class=line><span class=cl>        <span class=o>.</span><span class=na>sendNotification</span><span class=o>(</span><span class=s>&#34;gradle.onWillImporterConnect&#34;</span><span class=o>,</span> <span class=n>pipeName</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-typescript data-lang=typescript><span class=line><span class=cl><span class=c1>// Receive message from Java
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>private</span> <span class=nx>registerCommand</span><span class=p>()</span><span class=o>:</span> <span class=k>void</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>context</span><span class=p>.</span><span class=nx>subscriptions</span><span class=p>.</span><span class=nx>push</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=nx>vscode</span><span class=p>.</span><span class=nx>commands</span><span class=p>.</span><span class=nx>registerCommand</span><span class=p>(</span><span class=s2>&#34;gradle.onWillImporterConnect&#34;</span><span class=p>,</span> <span class=p>(</span><span class=nx>pipeName</span>: <span class=kt>string</span><span class=p>)</span> <span class=o>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>this</span><span class=p>.</span><span class=nx>_onImporterReady</span><span class=p>.</span><span class=nx>fire</span><span class=p>(</span><span class=nx>path</span><span class=p>.</span><span class=nx>resolve</span><span class=p>(</span><span class=nx>pipeName</span><span class=p>));</span>
</span></span><span class=line><span class=cl>        <span class=p>})</span>
</span></span><span class=line><span class=cl>    <span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>Since the import process controls initialization, communication is one-way, using notifications. The Java side cannot receive feedback from VSCode. Therefore, polling was used to establish the connection once VSCode was ready.</p><h4 id=connection-workflow>Connection Workflow<a hidden class=anchor aria-hidden=true href=#connection-workflow>#</a></h4><p>The entire connection process is illustrated below:</p><p><img loading=lazy src=https://raw.githubusercontent.com/Jiaaming/blogImage/main/pic/20240804110358.png alt="Connection Workflow"></p><p>This was the most complex part of the project, but it successfully merged the Build Server and Task Server.</p><h3 id=step-2-merging-language-server-to-gradle-server>Step 2: Merging Language Server to Gradle Server<a hidden class=anchor aria-hidden=true href=#step-2-merging-language-server-to-gradle-server>#</a></h3><p>This step was more straightforward. The VSCode Language Server and Client libraries support various connection methods.</p><p>By packaging the Language Server as a local dependency and using named pipes for communication, I was able to merge it with the Gradle Server seamlessly.</p><p><strong>Dependency Management:</strong></p><p>The primary challenge was handling shared dependencies between the Gradle Server and Gradle Language Server. By creating a <a href=https://stackoverflow.com/questions/19150811/what-is-a-fat-jar>fat JAR</a> for the Language Server and placing it at the end of the Gradle Server&rsquo;s classpath, dependency conflicts were resolved.</p><p>Certainly! Here&rsquo;s your translated and reorganized section in English:</p><hr><h2 id=performance-after-merge>Performance After Merge<a hidden class=anchor aria-hidden=true href=#performance-after-merge>#</a></h2><p>After Merge, it only got one single Java process <code>GradleServer</code>.
<img loading=lazy src=https://raw.githubusercontent.com/Jiaaming/blogImage/main/pic/af-merge.png alt=af-merge></p><h3 id=how-was-performance-measured>How Was Performance Measured?<a hidden class=anchor aria-hidden=true href=#how-was-performance-measured>#</a></h3><p>Memory consumption was the primary focus after the merge. Before the merge, we could determine total memory usage by monitoring the memory consumption of each of the three separate processes. I developed a Python script to automate this process.</p><h4 id=pre-merge-memory-monitoring>Pre-Merge Memory Monitoring<a hidden class=anchor aria-hidden=true href=#pre-merge-memory-monitoring>#</a></h4><ol><li><p><strong>Polling for Process IDs</strong>: The script first polls the system to find the process IDs (PIDs) of the three servers based on their class names.</p></li><li><p><strong>Monitoring Memory Usage</strong>: Using the <code>psutil</code> library, the script captures the <a href=https://www.baeldung.com/linux/resident-set-vs-virtual-memory-size>Resident Set Size (RSS)</a> usage of each process individually and then sums them up to obtain the total memory usage.</p></li></ol><p>This script runs before starting VSCode to monitor memory consumption when opening a Gradle project. It outputs memory usage data every second.</p><blockquote><p>What is <strong>RSS Monitoring</strong>? :</p><p>Resident Set Size (RSS), a measure provided by the operating system that indicates the actual amount of physical memory occupied by a process.</p><p>For Java programs, RSS includes not only the Java heap memory but also Metaspace, code cache, memory used by the JVM itself, and JVM stack space.</p></blockquote><h4 id=post-merge-memory-monitoring>Post-Merge Memory Monitoring<a hidden class=anchor aria-hidden=true href=#post-merge-memory-monitoring>#</a></h4><p>After merging the processes into a single thread, I used <code>Plotly</code> to visualize the memory usage:</p><ul><li><p><strong>Plotting Memory Usage</strong>: I plotted the sum of memory usage for the three pre-merge servers against the single merged process over time. This line chart illustrates real-time memory changes as a Gradle project is opened.</p></li><li><p><strong>Version Comparison</strong>: Between versions 3.13.5 (before the merge) and 3.16.2 (after the merge).</p></li></ul><h3 id=performance-results>Performance Results<a hidden class=anchor aria-hidden=true href=#performance-results>#</a></h3><p>To Test the performance, I used the four different size of project:</p><table><thead><tr><th>Project Size</th><th>Description</th><th>Number of Gradle Tasks</th></tr></thead><tbody><tr><td>Small</td><td>Basic project initialized with <code>Gradle init</code> command</td><td>34</td></tr><tr><td>Medium</td><td><a href=https://github.com/microsoft/vscode-gradle>microsoft/vscode-gradle</a> project</td><td>~380</td></tr><tr><td>Large</td><td><a href=https://github.com/apache/lucene>apache/lucene</a> project</td><td>~3,300</td></tr><tr><td>Super Large</td><td><a href=https://github.com/gradle/gradle>gradle/gradle</a> project</td><td>~42,000</td></tr></tbody></table><h4 id=small>Small<a hidden class=anchor aria-hidden=true href=#small>#</a></h4><p><img loading=lazy src=https://raw.githubusercontent.com/Jiaaming/blogImage/main/pic/small2.png alt=small2></p><h4 id=medium>Medium<a hidden class=anchor aria-hidden=true href=#medium>#</a></h4><p><img loading=lazy src=https://raw.githubusercontent.com/Jiaaming/blogImage/main/pic/medium.png alt=medium></p><h4 id=large>Large<a hidden class=anchor aria-hidden=true href=#large>#</a></h4><p><img loading=lazy src=https://raw.githubusercontent.com/Jiaaming/blogImage/main/pic/large.png alt=large></p><h4 id=super-large>Super Large<a hidden class=anchor aria-hidden=true href=#super-large>#</a></h4><p><img loading=lazy src=https://raw.githubusercontent.com/Jiaaming/blogImage/main/pic/super-large.png alt=super-large></p><p>The results showed significant memory savings, especially with smaller projects, demonstrating the efficiency of the merged architecture.</p></div><footer class=post-footer><ul class=post-tags><li><a href=https://jiaaming.cn/tags/%E6%8A%80%E6%9C%AF/>技术</a></li></ul><nav class=paginav><a class=next href=https://jiaaming.cn/en/post/chapter-11/><span class=title>Next »</span><br><span>How to Build a Simple AI Conversational Assistant Based on Langchain.js</span></a></nav><div class=share-buttons><a target=_blank rel="noopener noreferrer" aria-label="share Microsoft Intern Summary: Merging Servers in the VSCode Gradle Extension on twitter" href="https://twitter.com/intent/tweet/?text=Microsoft%20Intern%20Summary%3a%20Merging%20Servers%20in%20the%20VSCode%20Gradle%20Extension&url=https%3a%2f%2fjiaaming.cn%2fen%2fpost%2fms-intern-summary%2f&hashtags=%e6%8a%80%e6%9c%af"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM195.519 424.544c135.939.0 210.268-112.643 210.268-210.268.0-3.218.0-6.437-.153-9.502 14.406-10.421 26.973-23.448 36.935-38.314-13.18 5.824-27.433 9.809-42.452 11.648 15.326-9.196 26.973-23.602 32.49-40.92-14.252 8.429-30.038 14.56-46.896 17.931-13.487-14.406-32.644-23.295-53.946-23.295-40.767.0-73.87 33.104-73.87 73.87.0 5.824.613 11.494 1.992 16.858-61.456-3.065-115.862-32.49-152.337-77.241-6.284 10.881-9.962 23.601-9.962 37.088.0 25.594 13.027 48.276 32.95 61.456-12.107-.307-23.448-3.678-33.41-9.196v.92c0 35.862 25.441 65.594 59.311 72.49-6.13 1.686-12.72 2.606-19.464 2.606-4.751.0-9.348-.46-13.946-1.38 9.349 29.426 36.628 50.728 68.965 51.341-25.287 19.771-57.164 31.571-91.8 31.571-5.977.0-11.801-.306-17.625-1.073 32.337 21.15 71.264 33.41 112.95 33.41z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Microsoft Intern Summary: Merging Servers in the VSCode Gradle Extension on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&url=https%3a%2f%2fjiaaming.cn%2fen%2fpost%2fms-intern-summary%2f&title=Microsoft%20Intern%20Summary%3a%20Merging%20Servers%20in%20the%20VSCode%20Gradle%20Extension&summary=Microsoft%20Intern%20Summary%3a%20Merging%20Servers%20in%20the%20VSCode%20Gradle%20Extension&source=https%3a%2f%2fjiaaming.cn%2fen%2fpost%2fms-intern-summary%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Microsoft Intern Summary: Merging Servers in the VSCode Gradle Extension on reddit" href="https://reddit.com/submit?url=https%3a%2f%2fjiaaming.cn%2fen%2fpost%2fms-intern-summary%2f&title=Microsoft%20Intern%20Summary%3a%20Merging%20Servers%20in%20the%20VSCode%20Gradle%20Extension"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Microsoft Intern Summary: Merging Servers in the VSCode Gradle Extension on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fjiaaming.cn%2fen%2fpost%2fms-intern-summary%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Microsoft Intern Summary: Merging Servers in the VSCode Gradle Extension on whatsapp" href="https://api.whatsapp.com/send?text=Microsoft%20Intern%20Summary%3a%20Merging%20Servers%20in%20the%20VSCode%20Gradle%20Extension%20-%20https%3a%2f%2fjiaaming.cn%2fen%2fpost%2fms-intern-summary%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Microsoft Intern Summary: Merging Servers in the VSCode Gradle Extension on telegram" href="https://telegram.me/share/url?text=Microsoft%20Intern%20Summary%3a%20Merging%20Servers%20in%20the%20VSCode%20Gradle%20Extension&url=https%3a%2f%2fjiaaming.cn%2fen%2fpost%2fms-intern-summary%2f"><svg viewBox="2 2 28 28" height="30" width="30" fill="currentcolor"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Microsoft Intern Summary: Merging Servers in the VSCode Gradle Extension on ycombinator" href="https://news.ycombinator.com/submitlink?t=Microsoft%20Intern%20Summary%3a%20Merging%20Servers%20in%20the%20VSCode%20Gradle%20Extension&u=https%3a%2f%2fjiaaming.cn%2fen%2fpost%2fms-intern-summary%2f"><svg width="30" height="30" viewBox="0 0 512 512" fill="currentcolor" xmlns:inkscape="http://www.inkscape.org/namespaces/inkscape"><path d="M449.446.0C483.971.0 512 28.03 512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446zM183.8767 87.9921h-62.034L230.6673 292.4508V424.0079h50.6655V292.4508L390.1575 87.9921H328.1233L256 238.2489z"/></svg></a></div></footer><head><script src=https://unpkg.com/@waline/client@v2/dist/waline.js></script>
<link rel=stylesheet href=https://unpkg.com/@waline/client@v2/dist/waline.css></head><body><div id=waline></div><script>Waline.init({el:"#waline",serverURL:"https://blog-comment-snowy.vercel.app"})</script></body></article></main><footer class=footer><span>&copy; 2024 <a href=https://jiaaming.cn/>Jiaming's Blog</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>